# UI 使用指南

## 总览

Pyruns 的 Web UI 由三个主页面组成，通过左侧导航栏切换：

| 页面 | 图标 | 功能 |
|------|------|------|
| **Generator** | ⊕ | 加载配置模板 → 编辑参数 → 生成任务 |
| **Manager** | ☐ | 卡片式任务管理 → 批量运行/删除 → 查看详情 |
| **Monitor** | ♥ | 实时日志查看 → 任务状态监控 → 导出报告 |

页面顶部的 **Header** 持续显示 CPU、RAM 和 GPU 利用率。

---

## Header（页头）

### 系统指标

页头右侧实时显示系统资源使用情况（每 3 秒刷新）：

```
[CPU 45%]  [RAM 68%]  [G0 85% 8192/24576M]  [G1 12% 1024/24576M]
```

- **CPU**：`psutil.cpu_percent()` 百分比
- **RAM**：`psutil.virtual_memory().percent` 百分比
- **GPU**：每个 GPU 显示独立的芯片指标
  - `Gn`：GPU 索引
  - `util%`：GPU 利用率
  - `used/totalM`：显存使用/总量（MB）

所有 GPU 卡均以独立的芯片（chip）形式内联显示。

---

## Generator 页面

### 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│ Row 1: [Tasks Root ▢ 📂] [Template ▾] [🔒] [↻]            │
├───────────────────────────────────┬─────────────────────────┤
│ 参数编辑区                       │ 生成设置面板            │
│                                   │                         │
│  ┌──────────────────────┐        │  Task Name: [_______]   │
│  │ Parameters 工具栏    │        │  ☑ 自动时间戳命名       │
│  │ [展开] [折叠] [2cols]│        │                         │
│  │ [Form] [YAML]        │        │  批量语法提示:          │
│  └──────────────────────┘        │  Product: lr: 0.001|0.01│
│  ┌──────────────────────┐        │  Zip: seed: (1|2|3)     │
│  │ lr        [0.001  ]  │        │                         │
│  │ epochs    [10     ]  │        │  [===== GENERATE =====] │
│  │ ▶ model              │        │                         │
│  │   name  [resnet50]   │        │  无|语法→直接生成       │
│  │   size  [256     ]   │        │  有|语法→确认后批量生成  │
│  └──────────────────────┘        │                         │
└───────────────────────────────────┴─────────────────────────┘
```

### 操作流程

1. **选择配置模板**：从 Template 下拉框中选择 `config_default` 或某个已有任务的配置
2. **编辑参数**：在 Form 视图中直接修改输入框，或切换到 YAML 视图编辑原始 YAML
3. **设置任务名称**：输入名称或勾选自动时间戳
4. **生成任务**：点击 GENERATE

### Form 视图 vs YAML 视图

| 功能 | Form | YAML |
|------|------|------|
| 结构化编辑 | ✅ 递归嵌套表单 | ❌ |
| 原始格式编辑 | ❌ | ✅ CodeMirror 编辑器 |
| 嵌套折叠 | ✅ 可展开/折叠 | ❌ |
| 类型验证 | ✅ 自动推断 | ❌ 需手动保证 |
| ⭐ 星标标记 | ✅ 可标记常用参数 | ❌ |
| 批量语法高亮 | ✅ 彩色标记 | ❌ |
| 列数调节 | ✅ 1~9 列 | ❌ |

### 参数编辑器功能

- **嵌套字典**：自动识别字典类型参数，显示为可折叠的分组
- **星标标记** ⭐：点击参数名旁的星标，标记常用参数（标记状态存储在 `_meta_starred` 字段中）
- **批量语法**：支持 `|` 分隔的多值输入（详见 [批量生成语法](batch-syntax.md)）
- **紧凑布局**：输入框高度压缩至 26px，多列布局支持 1~9 列

---

## Manager 页面

### 页面布局

```
┌─────────────────────────────────────────────────────────────┐
│ Row 1: [Tasks Root ▢ 📂] [Filter ▾] [Search ___] [↻]      │
├─────────────────────────────────────────────────────────────┤
│ Row 2: [5 cols ▾]           [Workers: 1] [Mode ▾] [RUN] [🗑]│
├─────────────────────────────────────────────────────────────┤
│ Summary: ☑ 12 tasks    ● 2 running  ✓ 8 completed  ✗ 2    │
├─────────────────────────────────────────────────────────────┤
│ ☑ Pinned                                                    │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐              │
│ │ task1│ │ task2│ │      │ │      │ │      │              │
│ │ ⭐   │ │ ⭐   │ │      │ │      │ │      │              │
│ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘              │
│                                                              │
│ ☐ All Tasks                                                 │
│ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐              │
│ │ task3│ │ task4│ │ task5│ │ task6│ │ task7│              │
│ └──────┘ └──────┘ └──────┘ └──────┘ └──────┘              │
└─────────────────────────────────────────────────────────────┘
```

### 控制栏

| 控件 | 位置 | 说明 |
|------|------|------|
| **Tasks Root** | Row 1 左 | 任务存储目录，支持手动输入和文件夹选择 |
| **Filter** | Row 1 中 | 按状态筛选：All / Pending / Running / Completed / Failed |
| **Search** | Row 1 右 | 模糊搜索任务名称 |
| **Columns** | Row 2 左 | 调整卡片网格列数（1~9，默认 5） |
| **Workers** | Row 2 右 | 并行执行的最大任务数 |
| **Mode** | Row 2 右 | 执行模式：Thread（线程池） / Process（进程池） |
| **RUN SELECTED** | Row 2 右 | 批量运行已勾选的任务 |
| **🗑** | Row 2 右 | 批量软删除已勾选的任务（移至 `.trash`） |

### 任务卡片

每张卡片显示：

- ☑ 勾选框（用于批量操作）
- 任务名称 + 创建时间
- 📌 置顶按钮（hover 时显示）
- 状态徽章（颜色编码）
- 配置预览（前 6 个参数的摘要）
- 重跑次数标记
- 底部操作栏：Task Info / Config / Log / RUN / STOP / RERUN

### Task Dialog（任务详情对话框）

点击任务卡片打开详情对话框，包含 5 个标签页：

| 标签页 | 内容 |
|--------|------|
| **Task Info** | `task_info.json` 的 JSON 只读预览 |
| **Config** | `config.yaml` 的 YAML 只读预览 |
| **Run Log** | 日志文件查看器（支持 run.log + rerunN.log 切换） |
| **Notes** | 可编辑的笔记区域，保存到 `task_info.json` |
| **Env Vars** | PyCharm 风格的环境变量编辑器 |

对话框支持鼠标拖拽移动位置。

### 轮询机制

Manager 页面每 2 秒轮询一次：

1. `task_manager.refresh_from_disk()` — 仅读取 running/queued 任务的 `task_info.json`
2. 对比快照 — 仅在状态或进度变化时才刷新卡片网格
3. 任务数量变化时自动重新渲染

---

## Monitor 页面

### 页面布局

```
┌─────────────┬───────────────────────────────────────────────┐
│ Tasks       │ ⚫ task-name                        [run.log ▾]│
│ 🔍 Search   ├───────────────────────────────────────────────┤
│─────────────│                                               │
│ ☑ ✓ task-1  │  [2026-02-13 10:31:05] SYSTEM: Run Started   │
│ ☑ ● task-2  │  Epoch 1/100 | loss=0.892 | acc=45.2%        │
│ ☑ ✗ task-3  │  Epoch 2/100 | loss=0.534 | acc=72.1%        │
│ ☐ ⏳ task-4  │  [ANSI colored output rendered here]         │
│             │                                               │
│             │                                               │
│             │                                               │
│             │                                               │
│             │                                               │
│─────────────│                                               │
│[Export ⬇]   │                                               │
└─────────────┴───────────────────────────────────────────────┘
```

### 左侧任务列表

- **搜索框**：按名称过滤任务
- **任务排序**：running > queued > pending > failed > completed
- **状态图标**：彩色图标实时反映任务状态
- **名称截断**：长名称自动省略号截断，鼠标悬停显示完整名称
- **勾选框**：勾选任务用于导出
- **监控徽章**：显示 `add_monitor()` 写入的数据条数
- **手动刷新**：点击 ↻ 按钮手动同步磁盘

### 右侧日志查看器

- **ANSI 彩色渲染**：终端颜色代码自动转换为 HTML
- **增量推送**：仅推送新增的日志内容（不重建整个页面）
- **自动滚动**：新内容到达时自动滚动到底部
- **日志切换**：通过下拉框选择 `run.log` 或 `rerunN.log`

### 导出功能

1. 勾选要导出的任务（左侧列表的勾选框）
2. 点击底部的 **Export Reports** 按钮
3. 在弹出的对话框中选择格式：
   - **CSV**：扁平化的表格格式，适合 Excel 分析
   - **JSON**：结构化格式，包含任务名和完整监控数据

导出的数据来源于 `pyruns.add_monitor()` 写入的监控条目。

### 轮询机制

Monitor 页面每 1 秒轮询一次：

1. **任务状态刷新**：通过快照对比检测变化
2. **日志增量推送**：读取日志文件的新增部分，通过 JavaScript 直接追加到 DOM
3. **全量扫描**：每 30 秒执行一次 `scan_disk()` 检测新增/删除的任务

---

## 通用交互

### 键盘快捷键

| 操作 | 快捷键 |
|------|--------|
| 搜索框确认 | `Enter` |
| 清除搜索 | 输入框的 ✕ 按钮 |

### 状态颜色编码

| 状态 | 颜色 | 图标 |
|------|------|------|
| `pending` | 灰色 | ⏰ schedule |
| `queued` | 蓝色 | ⏳ hourglass_top |
| `running` | 琥珀色 | ▶ play_circle |
| `completed` | 绿色 | ✓ check_circle |
| `failed` | 红色 | ✗ error |

### 通知消息

操作结果通过右下角的通知消息反馈：

- 🟢 **positive**：成功操作（生成、运行、保存）
- 🟡 **warning**：警告信息（空选择、移至回收站）
- 🔴 **negative**：错误信息（验证失败、解析错误）

